<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/style_teste.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Teste</title>
</head>



<body onload="obterDadosGrafico()">


    <div class="container_background_teste">

        <!-- <div id="div_inicial" class="exibir">
            <button class="but" onclick="comecar_teste()"> Se inscreva! </button>
        </div> -->

        <div id="div_nome" class="exibir">
            <h1> Insira aqui seu nome e email para começar o teste:</h1>


            <div id="container_inp">
                <span>
                    Nome:</span>
                <input id="inp_nome" class="inp">
                <span> Email: </span>
                <input id="inp_email" class="inp">
            </div>
            <button class="but" onclick="iniciar()"> Iniciar teste </button>
        </div>



        <div id="q1" class="exibir">

            <div class="question_display">
                <h1> Como as pessoas ao seu redor te descrevem? </h1>
            </div>



            <div id="container_answer_buttons">


                <div onclick="salvarResposta('a')" id="a_q1" class="display_answer">
                    Distante mas com boas intenções
                </div>



                <div onclick="salvarResposta('b')" id="b_q1" class="display_answer">
                    Controlador e imponente
                </div>



                <div onclick="salvarResposta('c')" id="c_q1" class="display_answer">
                    Manipulador e vingativo
                </div>



                <div onclick="salvarResposta('d')" id="d_q1" class="display_answer">
                    Protetor e empático
                </div>


            </div>
        </div>


        <div id="q2" class="exibir">

            <div class="question_display">
                <h1> Qual dessas você considera como sua melhor qualidade?</h1>
            </div>



            <div id="container_answer_buttons">


                <div onclick="salvarResposta('a')" id="a_q2" class="display_answer">
                    Criatividade </div>



                <div onclick="salvarResposta('b')" id="b_q2" class="display_answer">
                    Confiança </div>



                <div onclick="salvarResposta('c')" id="c_q2" class="display_answer">
                    Engenhosidade </div>



                <div onclick="salvarResposta('d')" id="d_q2" class="display_answer">
                    Honestidade </div>


            </div>



        </div>

        <div id="q3" class="exibir">

            <div class="question_display">
                <h1> O quê mais importa para você em uma boa música?</h1>
            </div>



            <div id="container_answer_buttons">


                <div onclick="salvarResposta('a')" id="a_q3" class="display_answer">
                    Uma melodia agradável</div>



                <div onclick="salvarResposta('b')" id="b_q3" class="display_answer">
                    Uma Letra que eu me identifique </div>



                <div onclick="salvarResposta('c')" id="c_q3" class="display_answer">
                    Rimas com uma sacada inteligente por trás </div>



                <div onclick="salvarResposta('d')" id="d_q3" class="display_answer">
                    Uma história que me faça sentir como o autor se sentiu </div>


            </div>



        </div>

        <div id="q4" class="exibir">

            <div class="question_display">
                <h1> Que tipo de história mais te interessa em um livro ou filme? </h1>
            </div>



            <div id="container_answer_buttons">


                <div onclick="salvarResposta('a')" id="a_q4" class="display_answer">

                    Aventuras mágicas em mundos utópicos</div>



                <div onclick="salvarResposta('b')" id="b_q4" class="display_answer">

                    Dramas comoventes </div>



                <div onclick="salvarResposta('c')" id="c_q4" class="display_answer">
                    Histórias frias que mostram a realidade como ela é </div>



                <div onclick="salvarResposta('d')" id="d_q4" class="display_answer">
                    Comédias relaxantes </div>


            </div>

        </div>

        <div id="q5" class="exibir">

            <div class="question_display">
                <h1> Como gosta de passar seu tempo livre? </h1>
            </div>



            <div id="container_answer_buttons">


                <div onclick="salvarResposta('a')" id="a_q5" class="display_answer">
                    Aprendendo algo novo, de preferência sozinho</div>



                <div onclick="salvarResposta('b')" id="b_q5" class="display_answer">
                    Dormindo até não poder mais </div>



                <div onclick="salvarResposta('c')" id="c_q5" class="display_answer">
                    Planejando o que posso fazer nos próximos dias úteis </div>



                <div onclick="salvarResposta('d')" id="d_q5" class="display_answer">
                    Não importa desde que eu esteja com quem eu amo </div>


            </div>

        </div>


        <div id="q6" class="exibir">

            <div class="question_display">
                <h1> Escolha algo para se proteger na sua próxima aventura!</h1>
            </div>



            <div id="container_answer_buttons">


                <div onclick="salvarResposta('a')" id="a_q6" class="display_answer">
                    Magia na sua forma mais pura </div>



                <div onclick="salvarResposta('b')" id="b_q6" class="display_answer">
                    O melhor escudo já forjado </div>



                <div onclick="salvarResposta('c')" id="c_q6" class="display_answer">
                    Um arco e flechas penetrantes </div>



                <div onclick="salvarResposta('d')" id="d_q6" class="display_answer">
                    Uma espada herdada da minha família </div>


            </div>

        </div>



        <div id="q7" class="exibir">

            <div class="question_display">
                <h1> Em qual desses lugares você iria preferir morar? </h1>
            </div>



            <div id="container_answer_buttons">


                <div onclick="salvarResposta('a')" id="a_q7" class="display_answer">
                    Em um local afastado da cidade e bem arborizado </div>



                <div onclick="salvarResposta('b')" id="b_q7" class="display_answer">
                    Em uma casa ou apartamento bem grande e no centro da cidade,
                    perto de tudo! </div>



                <div onclick="salvarResposta('c')" id="c_q7" class="display_answer">
                    Em uma casa rústica perto da praia</div>



                <div onclick="salvarResposta('d')" id="d_q7" class="display_answer">
                    Numa cidade tranquila onde todos os vizinhos se conhecem </div>

            </div>

        </div>


        <div id="div_resultado" class="exibir">

            <div id="container_resultado_titulo">
                <h1>
                    <div id="resultado_titulo"></div>
                </h1>
            </div>

            <div id="container_resultado_img"></div>
            <div id="container_resultado_text"></div>
            <button id="but_refazer_teste" class="but" onclick="refazer_teste()"> Refazer teste </button>


        </div>


        <button id="but_finalizar" class="but" onclick="finalizar()" style="display: none;"> Finalizar teste </button>


        <button id="avancar" class="but" onclick="button_avancar()" style="display: none;"> Avançar </button>
    </div>


    <div class="container_background_chart">
        <h1>Resultados recolhidos</h1>
        <div class="display_chart">
            <div id="canva_size">
                <canvas id="myChartCanvas"> </canvas>
            </div>
        </div>
        <button class="but" id="button_home"> <a id="link_" href="index.html">
                Retornar à página inicial </a> </button>
    </div>

</body>

</html>

<script>
    var classe_name = sessionStorage.getItem('classe')
    var lista_classe = ['Mago', 'Realeza', 'Criatura da Floresta', 'Aldeão']
    var lista_img = ['<img src="../img/result_mago.png" style="height: 300px; width: 300px;">',
        '<img src="../img/result_realeza.png" style="height: 300px; width: 320px;">',
        '<img src="../img/result_criatura.png" style="height: 300px; width: 190px;">',
        '<img src="../img/result_aldeao.png" style="height: 300px; width: 320px;">',
    ]
    var lista_text = ["Sendo os mais poderosos no quesito mágico, Magos são conhecidos pela sua sede de conhecimento e por seu conforto com a solidão, apesar da sua notável distância emocional, sempre agem com o coração ",
        "Grandiosa e nobre, a realeza é a classe de maior poder em defesa, membros dessa classe são conhecidos pela sua audácia e coragem desmedida.",
        "As criaturas da Floresta são conhecidas por serem extremamente poderosas e até instáveis, membros dessa classe tendem a ser bons com estratégia e persuasão.",
        "Aldeões são a classe com maior força física e união, valorizam muito a família e conexões emocionais. Preferem calma à agitação no dia a dia"]

    var respostaAtual = ""
    var contador_a = 0
    var contador_b = 0
    var contador_c = 0
    var contador_d = 0

    var abcd = [contador_a, contador_b, contador_c, contador_d]



    div_resultado.style.display = "flex";
    div_nome.style.display = "none";
    


        if(classe_name == 'Mago' || classe_name == 'CF' || classe_name == 'Aldeao' || classe_name == 'Realeza'){
           
            div_resultado.style.display = "flex";
            div_nome.style.display = "none";
            but_refazer_teste.style.display = "flex";
            if(classe_name == 'Aldeao'){
            resultado_titulo.innerHTML = `${lista_classe[3]}`
            container_resultado_img.innerHTML = `${lista_img[3]}`
            container_resultado_text.innerHTML = `${lista_text[3]}`
            } else if(classe_name == 'Mago'){
                resultado_titulo.innerHTML = `${lista_classe[0]}`
            container_resultado_img.innerHTML = `${lista_img[0]}`
            container_resultado_text.innerHTML = `${lista_text[0]}`
            } else if(classe_name == 'Realeza'){
                resultado_titulo.innerHTML = `${lista_classe[1]}`
            container_resultado_img.innerHTML = `${lista_img[1]}`
            container_resultado_text.innerHTML = `${lista_text[1]}`
            } else if(classe_name == 'CF'){
                resultado_titulo.innerHTML = `${lista_classe[2]}`
            container_resultado_img.innerHTML = `${lista_img[2]}`
            container_resultado_text.innerHTML = `${lista_text[2]}`
            }

        }else if(classe_name == undefined){
            div_resultado.style.display = "none";
            div_nome.style.display = "flex";
        }


        // div_resultado.style.display === "flex" && classe_name == 'Mago' || classe_name == 'CF' || classe_name == 'Aldeão' || classe_name == 'Realeza') {
        //     div_nome.style.display = "flex"

        // } else if (div_nome.style.display === "flex" && inp_email.value != '' && inp_nome.value != '') {
        //     div_resultado.style.display = "none";
        //     q1.style.display = "flex";
        //     avancar.style.display = "inline-block";
        // }
        


    function iniciar() {
        if (div_nome.style.display === "flex" && inp_email.value != '' && inp_nome.value != '') {
            div_nome.style.display = "none";
            q1.style.display = "flex";
            avancar.style.display = "inline-block";
        }

        var nome_inserido = inp_nome.value
        var email_inserido = inp_email.value
        console.log(nome_inserido)
        sessionStorage.setItem('username', inp_nome.value);
        var user_name = sessionStorage.getItem('username');
        


        var usuario = {
            nomeServer: nome_inserido,
            emailServer: email_inserido,
        }

        console.log("USUARIO: ", usuario)

        fetch('/teste/usuario', {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(usuario)
        }).then(function (resposta) {
            console.log(resposta)
            if (resposta.ok) {
                console.log("cheguei no cadstro")
            } else {
                alert("Houve um erro ao tentar realizar o cadastro! Por favor insira nome e email!");

            }
        }).catch(function (erro) {
            console.log(erro)

        })
    }

    function salvarResposta(resposta) {
        respostaAtual = resposta
        console.log(respostaAtual)
    }


    function button_avancar() {


        if (respostaAtual == "") {
            alert('Selecione uma opção')
            return
        } else if (respostaAtual == "a") {
            contador_a++
            abcd.splice(0, 1, contador_a)
        } else if (respostaAtual == "b") {
            contador_b++
            abcd.splice(1, 1, contador_b)
        } else if (respostaAtual == "c") {
            contador_c++
            abcd.splice(2, 1, contador_c)
        } else {
            contador_d++
            abcd.splice(3, 1, contador_d)
        }
        respostaAtual = "";


        if (q1.style.display === "flex") {

            q1.style.display = "none";
            q2.style.display = "flex";

        } else if (q2.style.display === "flex") {

            q2.style.display = "none";
            q3.style.display = "flex";
        } else if (q3.style.display === "flex") {

            q3.style.display = "none";
            q4.style.display = "flex";
        } else if (q4.style.display === "flex") {

            q4.style.display = "none";
            q5.style.display = "flex";
        } else if (q5.style.display === "flex") {

            q5.style.display = "none";
            q6.style.display = "flex";
        } else if (q6.style.display === "flex") {

            q6.style.display = "none";
            q7.style.display = "flex";
            avancar.style.display = "none";
            but_finalizar.style.display = "inline-block";
        } else if (q7.style.display === "flex") {
            q7.style.display = "none";
            but_finalizar.style.display = "none";
            div_resultado.style.display = "flex";
        }


    }



    function finalizar() {

        button_avancar()

        var recorrente = 0
        var resultado = 'a'


        for (i = 0; i <= abcd.length; i++) {

            if (abcd[i] >= recorrente) {
                recorrente = abcd[i]
            }

        }

        if (recorrente === contador_a) {
            
            var classe = 'Mago';
            classe_name = sessionStorage.setItem('classe', 'Mago');
            resultado_titulo.innerHTML = `${lista_classe[0]}`
            container_resultado_img.innerHTML = `${lista_img[0]}`
            container_resultado_text.innerHTML = `${lista_text[0]}`
        }

        if (recorrente === contador_b) {
           

            var classe = 'Realeza';
            classe_name = sessionStorage.setItem('classe', 'Realeza');
            resultado_titulo.innerHTML = `${lista_classe[1]}`
            container_resultado_img.innerHTML = `${lista_img[1]}`
            container_resultado_text.innerHTML = `${lista_text[1]}`
        }

        if (recorrente === contador_c) {
            

            classe_name = sessionStorage.setItem('classe', 'CF');
            var classe = 'Criatura da Floresta';
            resultado_titulo.innerHTML = `${lista_classe[2]}`
            container_resultado_img.innerHTML = `${lista_img[2]}`
            container_resultado_text.innerHTML = `${lista_text[2]}`
        }

        if (recorrente === contador_d) {
           

            var classe = 'Aldeão';
            classe_name = sessionStorage.setItem('classe', 'Aldeao');
            var resultado_quizz = `${lista_classe[3]}`
            resultado_titulo.innerHTML = `${lista_classe[3]}`
            container_resultado_img.innerHTML = `${lista_img[3]}`
            container_resultado_text.innerHTML = `${lista_text[3]}`
        }



        var nome_inserido = inp_nome.value
        var email_inserido = inp_email.value
        var aVar = abcd[0]
        var bVar = abcd[1]
        var cVar = abcd[2]
        var dVar = abcd[3]
        console.log(aVar)
        console.log(bVar)
        console.log(cVar)
        console.log(dVar)
        var teste = {
            emailServer: email_inserido,
            classeServer: classe,
            aServer: aVar,
            bServer: bVar,
            cServer: cVar,
            dServer: dVar,
        }

        fetch('/teste/cadastrar/', {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(teste)
        }).then(function (resposta) {
            console.log(resposta)
            if (resposta.ok) {
                console.log("cheguei no cadastro")
                // setInterval(window.location.reload(true), 15000);
                window.location.reload(true)
            }
            else {
                alert("Houve um erro ao tentar realizar o cadastro!");
            }
        }).catch(function (erro) {
            console.log(erro)

        })

    }

    function refazer_teste() {

        abcd = [contador_a, contador_b, contador_c, contador_d];
        contador_a = 0;
        contador_b = 0;
        contador_c = 0;
        contador_d = 0;


        if (div_resultado.style.display === "flex") {
            div_nome.style.display = "flex";
            div_resultado.style.display = "none";
            but_refazer_teste.style.display = "none";
        }

    }





    ///GRAFICO

    function obterDadosGrafico() {

        // if (proximaAtualizacao != undefined) {
        //     clearTimeout(proximaAtualizacao);
        // }

        fetch(`/teste/pegarclasse/`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGrafico(resposta);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
    // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
    // A função *plotarGrafico* também invoca a função *atualizarGrafico*
    function plotarGrafico(resposta) {

        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = [];

        // Criando estrutura para plotar gráfico - dadootas
        Chart.defaults.font.size = 19;
        Chart.defaults.font.family = 'Metropolis-black';
        Chart.defaults.color = 'black';
        let dados = {
            labels: labels,
            datasets: [{
                label: 'Resultados mais comuns',
                data: [],
                backgroundColor: [
                    'rgb(35, 73, 73)',
                    'rgb(32, 53, 35)',
                    'rgb(135, 143, 60)',
                    'rgb(131, 24, 24)'
                ],
                // options: {
                //     plugins: {
                //         legend: {
                //             labels: {
                //                 font: {
                //                     size: 15,
                //                     family: "Metropolis-black"
                //                 }
                //             }
                //         }
                //     }
                // },
                fill: true,
                borderColor: 'rgb(82, 70, 53)',
                tension: 0.1
            }]
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro.class);
            dados.datasets[0].data.push(registro.numclass);
            // dados.datasets[1].data.push(registro.temperatura);
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        // const config = {
        //     type: 'doughnut',
        //     data: dados,
        // };

        // Adicionando gráfico criado em div na tela
        const grafico = document.getElementById(`myChartCanvas`)
        let myChart = new Chart(grafico,
            {
                type: 'pie',
                data: dados,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        );

        // setTimeout(() => atualizarGrafico(dados, myChart), 2000);
    }


    // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
    // buscando a última medida inserida em tabela contendo as capturas, 

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    function atualizarGrafico(dados, myChart) {
        fetch(`/teste/pegaratt/`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {
                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(dados);
                    if (novoRegistro[0].class == dados.labels[dados.labels.length - 1]) {
                        console.log("---------------------------------------------------------------")
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        // avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                        // console.log("Horário do novo dado capturado:")
                        // console.log(novoRegistro[0].momento_grafico)
                        // console.log("Horário do último dado capturado:")
                        // console.log(dados.labels[dados.labels.length - 1])
                        // console.log("---------------------------------------------------------------")
                    } else {
                        // tirando e colocando valores no gráfico
                        dados.labels.shift(); // apagar o primeiro
                        dados.labels.push(novoRegistro[0].class); // incluir um novo momento
                        dados.labels.push(novoRegistro[1].class); // incluir um novo momento

                        dados.datasets[0].data.shift();  // apagar o primeiro 
                        dados.datasets[1].data.shift();  // apagar o segundo
                        dados.datasets[0].data.push(novoRegistro[0].numclass); // incluir uma nova medida 1
                        dados.datasets[1].data.push(novoRegistro[0].numclass); // incluir uma nova medida 2

                        myChart.update();
                    }

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    // proximaAtualizacao = setTimeout(() => atualizarGrafico(dados, myChart), 2000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                // proximaAtualizacao = setTimeout(() => atualizarGrafico( dados, myChart), 2000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }


</script>